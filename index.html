<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audible Morse Code Trainer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: visible;
            position: relative;
        }
        
        .control-group h3 {
            margin-top: 0;
            color: #ffd700;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input, select, button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-sizing: border-box;
        }
        
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23333" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }
        
        .control-group input, .control-group select, .control-group button {
            width: 100%;
            box-sizing: border-box;
        }
        
        .control-group select {
            position: relative;
            z-index: 10;
            max-width: 100%;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .practice-area {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .display-text {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            min-height: 60px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            letter-spacing: 2px;
        }
        
        .input-text {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            min-height: 60px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            letter-spacing: 2px;
        }
        
        .input-text input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 0;
        }
        
        .input-text input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .input-area {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
            justify-content: center;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc66);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .collapsible-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .section-header h3 {
            color: #ffd700;
            margin: 0;
        }
        
        .toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .section-content {
            margin-top: 20px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        
        .section-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin-top: 0;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .char-button {
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .char-button.learned {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }
        
        .char-button.current {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            color: #ffd700;
            margin-top: 0;
        }
        
        .timer {
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-align: center;
            margin: 20px 0;
        }
        
        .group-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .group-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .group-btn span {
            font-size: 12px;
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }
        
        .group-btn:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .group-btn.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .current-group-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .current-group-display h4 {
            color: #ffd700;
            margin-top: 0;
        }
        
        .group-chars-display {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            color: white;
            letter-spacing: 4px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .individual-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .individual-controls button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            margin: 0;
        }
        
        .individual-controls button:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }
        
        .custom-character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .custom-char-button {
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            color: white;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-char-button:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .custom-char-button.selected {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .custom-set-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .custom-set-display h4 {
            color: #ffd700;
            margin-top: 0;
        }
        
        .reference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .reference-char-button {
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            color: white;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reference-char-button:hover {
            border-color: #00bcd4;
            background: rgba(0, 188, 212, 0.2);
            transform: translateY(-2px);
        }
        
        .reference-char-button:active {
            transform: translateY(0);
            background: rgba(0, 188, 212, 0.4);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
        
        .footer-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .footer-buttons button {
            width: auto;
            padding: 10px 20px;
            margin: 0;
        }
        
        .beer-button {
            background: linear-gradient(45deg, #f39c12, #e67e22) !important;
        }
        
        .reset-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Audible Morse Code Trainer</h1>
        
        <div class="instructions">
            <h3>Koch Method Training Protocol</h3>
            <p><strong>Goal:</strong> High Speed Reception | <strong>Method:</strong> Sound Recognition Only</p>
            <ul>
                <li>Best practice is to start at your target WPM and not increase read speed over time</li>
                <li>NO visual morse patterns - train your ear, not your eyes</li>
                <li>Master each character group before advancing</li>
                <li>Focus on instant recognition of sound patterns</li>
                <li>Practice 30-60 minutes daily for optimal results</li>
            </ul>
        </div>

        <div class="control-panel">
            <div class="control-group">
                <h3>‚ö° Speed Settings</h3>
                <label>Character Speed (WPM):</label>
                <input type="range" id="wpm" min="10" max="40" value="20">
                <span id="wpmValue">20 WPM</span>
            </div>
            
            <div class="control-group">
                <h3>üéµ Audio Settings</h3>
                <label>Tone Frequency (Hz):</label>
                <input type="range" id="frequency" min="400" max="1000" value="600">
                <span id="frequencyValue">600 Hz</span>
                
                <label>Volume:</label>
                <input type="range" id="volume" min="0" max="100" value="70">
                <span id="volumeValue">70%</span>
            </div>
            
            <div class="control-group">
                <h3>üìö Training Mode</h3>
                <select id="trainingMode">
                    <option value="custom">Selected Group</option>
                    <option value="individual">Individual Practice</option>
                    <option value="koch">Koch Method</option>
                    <option value="random">Random Characters</option>
                    <option value="words">Common Words</option>
                    <option value="callsigns">Callsigns</option>
                    <option value="numbers">Numbers</option>
                </select>
                
                <label>Characters per Group:</label>
                <input type="number" id="groupSize" min="1" max="10" value="5">
            </div>
            
            <div class="control-group">
                <h3>‚è±Ô∏è Session Settings</h3>
                <label>Session Duration (minutes):</label>
                <input type="number" id="sessionDuration" min="5" max="60" value="20">
                
                <button id="startSession">Start Training Session</button>
                <button id="stopSession" disabled>Stop Session</button>
            </div>
        </div>

        <div class="practice-area">
            <div class="timer" id="sessionTimer">20:00</div>
            
            <div class="display-text" id="displayText">
                Click "Start Training Session" to begin learning Morse Code the right way!
            </div>
            
            <div class="input-text" id="userInputDisplay">
                <input type="text" id="userInput" placeholder="Type what you hear..." disabled>
            </div>
            
            <div class="input-area">
                <button id="repeatAudio" disabled>üîÅ Repeat</button>
                <button id="checkAnswer" disabled>Check</button>
                <button id="nextGroup" disabled>Next Group</button>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div>Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="streak">0</div>
                    <div>Streak</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalChars">0</div>
                    <div>Characters</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="sessionTime">0</div>
                    <div>Minutes</div>
                </div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('kochProgress')">
                <h3>üìà Koch Method Progress</h3>
                <button class="toggle-btn" id="toggle-kochProgress">Hide</button>
            </div>
            <div class="section-content" id="kochProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgress"></div>
                </div>
                <p>Lesson <span id="currentLesson">1</span> of 43 | <span id="progressPercent">0%</span> Complete</p>
                
                <div class="character-grid" id="characterGrid"></div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('reference')">
                <h3>üìä Character Reference - Click to Hear</h3>
                <button class="toggle-btn" id="toggle-reference">Hide</button>
            </div>
            <div class="section-content" id="reference">
                <p>Click any character below to hear how it sounds in Morse code</p>
                <div class="reference-grid" id="referenceGrid"></div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('characterGroups')">
                <h3>üéØ Character Group Selection</h3>
                <button class="toggle-btn" id="toggle-characterGroups">Hide</button>
            </div>
            <div class="section-content" id="characterGroups">
                <p>Select a character group to practice with. Start simple and work your way up!</p>
                
                <div class="group-buttons">
                    <button class="group-btn active" data-group="basic">Basic 5<br><span>E T A O I</span></button>
                    <button class="group-btn" data-group="common">Common 10<br><span>E T A O I N S H R D</span></button>
                    <button class="group-btn" data-group="letters">All Letters<br><span>A-Z (26 chars)</span></button>
                    <button class="group-btn" data-group="numbers">+ Numbers<br><span>Letters + 0-9</span></button>
                    <button class="group-btn" data-group="punctuation">+ Punctuation<br><span>. , ? / - =</span></button>
                    <button class="group-btn" data-group="all">Complete Set<br><span>All 43 characters</span></button>
                </div>
                
                <div class="current-group-display">
                    <h4>Current Practice Set:</h4>
                    <div id="currentGroupChars" class="group-chars-display">E T A O I</div>
                    <p id="groupDescription">Start with the 5 most common letters in English</p>
                </div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('individualPractice')">
                <h3>üéØ Individual Character Practice</h3>
                <button class="toggle-btn" id="toggle-individualPractice">Hide</button>
            </div>
            <div class="section-content" id="individualPractice">
                <p>Click characters to add/remove from your custom practice set. Selected characters will appear highlighted.</p>
                
                <div class="individual-controls">
                    <button id="clearCustom">Clear All</button>
                    <button id="selectAllVisible">Select All Visible</button>
                    <button id="useCustomSet">Use Custom Set</button>
                </div>
                
                <div class="custom-character-grid" id="customCharacterGrid"></div>
                
                <div class="custom-set-display">
                    <h4>Your Custom Set: <span id="customCount">0</span> characters</h4>
                    <div id="customSetChars" class="group-chars-display">Click characters above to build your set</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Created by MW7GHQ</p>
            <div class="footer-buttons">
                <button id="resetProgress" class="reset-button">Reset Progress</button>
                <button id="buyMeABeer" class="beer-button">üç∫ Buy Me a Beer</button>
            </div>
        </div>
    </div>

    <script>
        // Morse code definitions
        const morseCode = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--',
            '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..',
            '9': '----.', '0': '-----', '/': '-..-.', '?': '..--..', '.': '.-.-.-',
            ',': '--..--', ':': '---...', ';': '-.-.-.', '(': '-.--.', ')': '-.--.-',
            '"': '.-..-.', "'": '.----.', '-': '-....-', '=': '-...-', '+': '.-.-.',
            '@': '.--.-.'
        };

        // Koch method character order
        const kochOrder = ['K', 'M', 'U', 'R', 'E', 'S', 'N', 'A', 'P', 'T', 'L', 'W', 'I', 
                          '.', 'J', 'Z', '=', 'F', 'O', 'Y', ',', 'V', 'G', '5', '/', 'Q', 
                          '9', '2', 'H', '3', '8', 'B', '?', '4', '7', 'C', '1', 'D', '6', 
                          '0', 'X', ';', '+', '@', "'"];

        // Common words for practice
        const commonWords = ['THE', 'AND', 'FOR', 'ARE', 'BUT', 'NOT', 'YOU', 'ALL', 'CAN', 'HER', 
                           'WAS', 'ONE', 'OUR', 'OUT', 'DAY', 'GET', 'USE', 'MAN', 'NEW', 'NOW',
                           'WAY', 'MAY', 'SAY', 'EACH', 'WHICH', 'THEIR', 'TIME', 'WILL', 'ABOUT',
                           'IF', 'UP', 'OUT', 'MANY', 'THEN', 'THEM', 'THESE', 'SO', 'SOME', 'HER',
                           'WOULD', 'MAKE', 'LIKE', 'INTO', 'HIM', 'HAS', 'TWO', 'MORE', 'GO', 'NO',
                           'DO', 'DOES', 'DID', 'WHAT', 'WHERE', 'WHEN', 'WHO', 'HOW', 'WHY', 'CALL'];

        // Character groups for progressive learning
        const characterGroups = {
            basic: {
                chars: ['E', 'T', 'A', 'O', 'I'],
                name: 'Basic 5',
                description: 'Start with the 5 most common letters in English'
            },
            common: {
                chars: ['E', 'T', 'A', 'O', 'I', 'N', 'S', 'H', 'R', 'D'],
                name: 'Common 10', 
                description: 'The 10 most frequently used letters'
            },
            letters: {
                chars: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 
                       'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
                name: 'All Letters',
                description: 'Complete alphabet A-Z (26 characters)'
            },
            numbers: {
                chars: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 
                       'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
                       '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
                name: 'Letters + Numbers',
                description: 'All letters plus digits 0-9 (36 characters)'
            },
            punctuation: {
                chars: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 
                       'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
                       '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
                       '.', ',', '?', '/', '-', '='],
                name: 'With Punctuation',
                description: 'Letters, numbers, and common punctuation (42 characters)'
            },
            all: {
                chars: Object.keys(morseCode),
                name: 'Complete Set',
                description: 'All available characters including prosigns (43 characters)'
            }
        };

        // Callsign patterns
        const callsignPrefixes = ['W', 'K', 'N', 'A', 'VE', 'G', 'JA', 'DL', 'F', 'I', 'OH', 'SM'];

        let selectedGroup = 'basic';
        let customCharacters = new Set();
        
        // Audio context and training variables
        let audioContext;
        let currentSession = false;
        let sessionStartTime;
        let sessionTimer;
        let currentChars = [];
        let currentText = '';
        let stats = { correct: 0, total: 0, streak: 0, maxStreak: 0 };
        let currentLesson = 1;

        // Storage keys
        const STORAGE_KEYS = {
            CURRENT_LESSON: 'morse_current_lesson',
            STATS: 'morse_stats',
            CUSTOM_CHARS: 'morse_custom_chars',
            SELECTED_GROUP: 'morse_selected_group',
            SETTINGS: 'morse_settings',
            COLLAPSED_SECTIONS: 'morse_collapsed_sections'
        };

        // Collapsed sections state
        let collapsedSections = new Set();

        // Initialize the application
        function initializeApp() {
            loadProgress();
            loadSettings();
            loadCollapsedSections();
            setupEventListeners();
            updateCharacterGrid();
            initializeAudio();
            selectCharacterGroup(selectedGroup);
            createCustomCharacterGrid();
            createReferenceGrid();
            applyCollapsedSections();
        }

        function setupEventListeners() {
            // Speed controls
            document.getElementById('wpm').addEventListener('input', function() {
                updateSpeedDisplay();
                saveSettings();
            });
            document.getElementById('frequency').addEventListener('input', function() {
                updateAudioDisplay();
                saveSettings();
            });
            document.getElementById('volume').addEventListener('input', function() {
                updateAudioDisplay();
                saveSettings();
            });
            
            // Training mode and group size
            document.getElementById('trainingMode').addEventListener('change', saveSettings);
            document.getElementById('groupSize').addEventListener('change', saveSettings);
            document.getElementById('sessionDuration').addEventListener('change', saveSettings);
            
            // Session controls
            document.getElementById('startSession').addEventListener('click', startTrainingSession);
            document.getElementById('stopSession').addEventListener('click', stopTrainingSession);
            
            // Practice controls
            document.getElementById('repeatAudio').addEventListener('click', repeatCurrentGroup);
            document.getElementById('checkAnswer').addEventListener('click', checkAnswer);
            document.getElementById('nextGroup').addEventListener('click', generateNextGroup);
            
            // Character group selection
            document.querySelectorAll('.group-btn').forEach(btn => {
                btn.addEventListener('click', (e) => selectCharacterGroup(e.target.dataset.group));
            });
            
            // Individual character practice controls
            document.getElementById('clearCustom').addEventListener('click', clearCustomCharacters);
            document.getElementById('selectAllVisible').addEventListener('click', selectAllVisibleCharacters);
            document.getElementById('useCustomSet').addEventListener('click', useCustomCharacterSet);
            
            // Footer buttons
            document.getElementById('resetProgress').addEventListener('click', resetProgress);
            document.getElementById('buyMeABeer').addEventListener('click', () => {
                window.open('https://www.buymeacoffee.com/', '_blank');
            });
            
            // Enter key handling
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
        }

        function initializeAudio() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            } catch (error) {
                console.warn('Audio initialization failed:', error);
            }
        }

        function updateSpeedDisplay() {
            const wpm = document.getElementById('wpm').value;
            document.getElementById('wpmValue').textContent = wpm + ' WPM';
        }

        function updateAudioDisplay() {
            const frequency = document.getElementById('frequency').value;
            const volume = document.getElementById('volume').value;
            document.getElementById('frequencyValue').textContent = frequency + ' Hz';
            document.getElementById('volumeValue').textContent = volume + '%';
        }

        function updateCharacterGrid() {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';
            
            kochOrder.forEach((char, index) => {
                const button = document.createElement('div');
                button.className = 'char-button';
                button.textContent = char;
                
                if (index < (currentLesson - 1) * 2) {
                    button.className += ' learned';
                } else if (index < currentLesson * 2) {
                    button.className += ' current';
                }
                
                button.addEventListener('click', () => playCharacter(char));
                grid.appendChild(button);
            });
            
            updateProgress();
        }

        function updateProgress() {
            const progressPercent = Math.round((currentLesson / 22) * 100);
            document.getElementById('currentLesson').textContent = currentLesson;
            document.getElementById('progressPercent').textContent = progressPercent;
            document.getElementById('overallProgress').style.width = progressPercent + '%';
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const toggleBtn = document.getElementById('toggle-' + sectionId);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                toggleBtn.textContent = 'Hide';
                collapsedSections.delete(sectionId);
            } else {
                content.classList.add('collapsed');
                content.style.maxHeight = '0px';
                toggleBtn.textContent = 'Show';
                collapsedSections.add(sectionId);
            }
            
            saveCollapsedSections();
        }

        function applyCollapsedSections() {
            collapsedSections.forEach(sectionId => {
                const content = document.getElementById(sectionId);
                const toggleBtn = document.getElementById('toggle-' + sectionId);
                if (content && toggleBtn) {
                    content.classList.add('collapsed');
                    content.style.maxHeight = '0px';
                    toggleBtn.textContent = 'Show';
                }
            });
            
            // Set max-height for non-collapsed sections
            document.querySelectorAll('.section-content:not(.collapsed)').forEach(content => {
                content.style.maxHeight = content.scrollHeight + 'px';
            });
        }

        function startTrainingSession() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            } catch (error) {
                console.error('Audio context error:', error);
                alert('Audio initialization failed. Please check your browser audio settings.');
                return;
            }
            
            currentSession = true;
            sessionStartTime = Date.now();
            
            document.getElementById('startSession').disabled = true;
            document.getElementById('stopSession').disabled = false;
            document.getElementById('userInput').disabled = false;
            document.getElementById('repeatAudio').disabled = false;
            document.getElementById('checkAnswer').disabled = false;
            document.getElementById('nextGroup').disabled = false;
            
            const duration = parseInt(document.getElementById('sessionDuration').value);
            startSessionTimer(duration);
            
            generateCurrentLessonChars();
            generateNextGroup();
            
            setTimeout(() => {
                document.getElementById('userInput').focus();
            }, 100);
            
            document.getElementById('displayText').textContent = 'Session started! Listen carefully and type what you hear.';
        }

        function stopTrainingSession() {
            currentSession = false;
            
            document.getElementById('startSession').disabled = false;
            document.getElementById('stopSession').disabled = true;
            document.getElementById('userInput').disabled = true;
            document.getElementById('repeatAudio').disabled = true;
            document.getElementById('checkAnswer').disabled = true;
            document.getElementById('nextGroup').disabled = true;
            
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            
            showSessionSummary();
        }

        function createCustomCharacterGrid() {
            const grid = document.getElementById('customCharacterGrid');
            grid.innerHTML = '';
            
            Object.keys(morseCode).forEach(char => {
                const button = document.createElement('div');
                button.className = 'custom-char-button';
                button.textContent = char;
                button.dataset.char = char;
                
                if (customCharacters.has(char)) {
                    button.classList.add('selected');
                }
                
                button.addEventListener('click', () => toggleCustomCharacter(char, button));
                grid.appendChild(button);
            });
            
            updateCustomSetDisplay();
        }

        function toggleCustomCharacter(char, buttonElement) {
            if (customCharacters.has(char)) {
                customCharacters.delete(char);
                buttonElement.classList.remove('selected');
            } else {
                customCharacters.add(char);
                buttonElement.classList.add('selected');
            }
            updateCustomSetDisplay();
            
            saveProgress();
            
            playCharacter(char);
        }

        function clearCustomCharacters() {
            customCharacters.clear();
            document.querySelectorAll('.custom-char-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            updateCustomSetDisplay();
        }

        function selectAllVisibleCharacters() {
            clearCustomCharacters();
            Object.keys(morseCode).forEach(char => {
                customCharacters.add(char);
                const button = document.querySelector(`[data-char="${char}"]`);
                if (button) button.classList.add('selected');
            });
            updateCustomSetDisplay();
        }

        function useCustomCharacterSet() {
            if (customCharacters.size === 0) {
                alert('Please select at least one character first!');
                return;
            }
            
            document.getElementById('trainingMode').value = 'individual';
            
            const charArray = Array.from(customCharacters).sort();
            document.getElementById('currentGroupChars').textContent = charArray.join(' ');
            document.getElementById('groupDescription').textContent = `Custom selection: ${customCharacters.size} characters`;
            
            document.querySelectorAll('.group-btn').forEach(btn => btn.classList.remove('active'));
        }

        function updateCustomSetDisplay() {
            const count = customCharacters.size;
            const charArray = Array.from(customCharacters).sort();
            
            document.getElementById('customCount').textContent = count;
            document.getElementById('customSetChars').textContent = 
                count > 0 ? charArray.join(' ') : 'Click characters above to build your set';
        }

        function createReferenceGrid() {
            const grid = document.getElementById('referenceGrid');
            grid.innerHTML = '';
            
            Object.keys(morseCode).forEach(char => {
                const button = document.createElement('div');
                button.className = 'reference-char-button';
                button.textContent = char;
                button.title = `Click to hear "${char}" (${morseCode[char]})`;
                
                button.addEventListener('click', () => {
                    button.style.background = 'rgba(0, 188, 212, 0.4)';
                    setTimeout(() => {
                        button.style.background = '';
                    }, 200);
                    
                    playCharacter(char);
                });
                
                grid.appendChild(button);
            });
        }

        function startSessionTimer(minutes) {
            let totalSeconds = minutes * 60;
            
            const timerDisplay = document.getElementById('sessionTimer');
            const sessionTimeDisplay = document.getElementById('sessionTime');
            
            sessionTimer = setInterval(() => {
                totalSeconds--;
                
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                const elapsedMinutes = Math.round((Date.now() - sessionStartTime) / 60000);
                sessionTimeDisplay.textContent = elapsedMinutes;
                
                if (totalSeconds <= 0) {
                    stopTrainingSession();
                }
            }, 1000);
        }

        function generateCurrentLessonChars() {
            const charsInLesson = currentLesson * 2;
            currentChars = kochOrder.slice(0, charsInLesson);
        }

        function selectCharacterGroup(groupKey) {
            selectedGroup = groupKey;
            const group = characterGroups[groupKey];
            
            document.querySelectorAll('.group-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-group="${groupKey}"]`).classList.add('active');
            
            currentChars = [...group.chars];
            
            document.getElementById('currentGroupChars').textContent = group.chars.join(' ');
            document.getElementById('groupDescription').textContent = group.description;
            
            document.getElementById('trainingMode').value = 'custom';
            
            saveProgress();
        }

        function generateNextGroup() {
            const mode = document.getElementById('trainingMode').value;
            const groupSize = parseInt(document.getElementById('groupSize').value);
            
            let text = '';
            
            switch (mode) {
                case 'custom':
                    for (let i = 0; i < groupSize; i++) {
                        text += currentChars[Math.floor(Math.random() * currentChars.length)];
                    }
                    break;
                case 'individual':
                    const customArray = Array.from(customCharacters);
                    if (customArray.length === 0) {
                        document.getElementById('displayText').textContent = 'Please select characters for individual practice first!';
                        return;
                    }
                    for (let i = 0; i < groupSize; i++) {
                        text += customArray[Math.floor(Math.random() * customArray.length)];
                    }
                    break;
                case 'koch':
                    for (let i = 0; i < groupSize; i++) {
                        text += currentChars[Math.floor(Math.random() * currentChars.length)];
                    }
                    break;
                case 'random':
                    const allChars = Object.keys(morseCode);
                    for (let i = 0; i < groupSize; i++) {
                        text += allChars[Math.floor(Math.random() * allChars.length)];
                    }
                    break;
                case 'words':
                    text = commonWords[Math.floor(Math.random() * commonWords.length)];
                    break;
                case 'callsigns':
                    text = generateCallsign();
                    break;
                case 'numbers':
                    for (let i = 0; i < groupSize; i++) {
                        text += Math.floor(Math.random() * 10).toString();
                    }
                    break;
            }
            
            currentText = text.toUpperCase();
            const inputField = document.getElementById('userInput');
            inputField.value = '';
            
            setTimeout(() => {
                if (!inputField.disabled) {
                    inputField.focus();
                }
            }, 50);
            
            playMorseText(currentText);
        }

        function repeatCurrentGroup() {
            if (currentText && currentSession) {
                playMorseText(currentText);
                document.getElementById('displayText').textContent = 'Repeating...';
                setTimeout(() => {
                    const inputField = document.getElementById('userInput');
                    if (!inputField.disabled) {
                        inputField.focus();
                    }
                }, 50);
            }
        }

        function generateCallsign() {
            const prefix = callsignPrefixes[Math.floor(Math.random() * callsignPrefixes.length)];
            const suffix = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + 
                          String.fromCharCode(65 + Math.floor(Math.random() * 26)) + 
                          String.fromCharCode(65 + Math.floor(Math.random() * 26));
            return prefix + Math.floor(Math.random() * 10) + suffix;
        }

        function playMorseText(text) {
            const wpm = parseInt(document.getElementById('wpm').value);
            
            const dotDuration = 1200 / wpm;
            const charSpacing = dotDuration * 3;
            const wordSpacing = dotDuration * 7;
            
            let currentTime = audioContext.currentTime + 0.1;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === ' ') {
                    currentTime += wordSpacing / 1000;
                    continue;
                }
                
                const pattern = morseCode[char];
                if (!pattern) continue;
                
                for (let j = 0; j < pattern.length; j++) {
                    const element = pattern[j];
                    const duration = element === '.' ? dotDuration : dotDuration * 3;
                    
                    playTone(currentTime, duration / 1000);
                    currentTime += (duration + dotDuration) / 1000;
                }
                
                currentTime += charSpacing / 1000 - dotDuration / 1000;
            }
        }

        function playCharacter(char) {
            const pattern = morseCode[char];
            if (!pattern) return;
            
            const wpm = parseInt(document.getElementById('wpm').value);
            const dotDuration = 1200 / wpm;
            
            let currentTime = audioContext.currentTime + 0.1;
            
            for (let i = 0; i < pattern.length; i++) {
                const element = pattern[i];
                const duration = element === '.' ? dotDuration : dotDuration * 3;
                
                playTone(currentTime, duration / 1000);
                currentTime += (duration + dotDuration) / 1000;
            }
        }

        function playTone(startTime, duration) {
            if (!audioContext) return;
            
            try {
                const frequency = parseInt(document.getElementById('frequency').value);
                const volume = parseInt(document.getElementById('volume').value) / 100;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(volume, startTime + duration - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            } catch (error) {
                console.error('Tone generation error:', error);
            }
        }

        function checkAnswer() {
            const userInput = document.getElementById('userInput').value.toUpperCase().trim();
            const isCorrect = userInput === currentText;
            
            stats.total++;
            if (isCorrect) {
                stats.correct++;
                stats.streak++;
                stats.maxStreak = Math.max(stats.maxStreak, stats.streak);
                
                document.getElementById('displayText').textContent = 
                    `‚úÖ Correct! You heard: "${currentText}"`;
                document.getElementById('displayText').style.color = '#00ff88';
                
                if (stats.streak >= 10 && stats.total >= 50) {
                    const accuracy = (stats.correct / stats.total) * 100;
                    if (accuracy >= 90 && currentLesson < 22) {
                        currentLesson++;
                        generateCurrentLessonChars();
                        updateCharacterGrid();
                        document.getElementById('displayText').textContent += 
                            ` üéâ Advancing to lesson ${currentLesson}!`;
                        stats = { correct: 0, total: 0, streak: 0, maxStreak: stats.maxStreak };
                        saveProgress();
                    }
                }
            } else {
                stats.streak = 0;
                document.getElementById('displayText').textContent = 
                    `‚ùå Incorrect. You heard: "${currentText}" but typed: "${userInput}"`;
                document.getElementById('displayText').style.color = '#ff6b6b';
            }
            
            updateStats();
            saveProgress();
            
            document.getElementById('userInput').value = '';
            document.getElementById('userInput').focus();
            
            setTimeout(() => {
                document.getElementById('displayText').style.color = 'white';
                generateNextGroup();
                setTimeout(() => {
                    const inputField = document.getElementById('userInput');
                    if (!inputField.disabled) {
                        inputField.focus();
                    }
                }, 100);
            }, 2000);
        }

        function updateStats() {
            const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('streak').textContent = stats.streak;
            document.getElementById('totalChars').textContent = stats.total * parseInt(document.getElementById('groupSize').value);
        }

        function showSessionSummary() {
            const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
            const sessionMinutes = Math.round((Date.now() - sessionStartTime) / 60000);
            
            document.getElementById('displayText').innerHTML = `
                <h3>üìä Session Complete!</h3>
                <p><strong>Duration:</strong> ${sessionMinutes} minutes</p>
                <p><strong>Accuracy:</strong> ${accuracy}%</p>
                <p><strong>Groups Completed:</strong> ${stats.total}</p>
                <p><strong>Best Streak:</strong> ${stats.maxStreak}</p>
                <p><strong>Current Lesson:</strong> ${currentLesson}</p>
            `;
        }

        // Progress persistence functions
        async function saveProgress() {
            try {
                await window.storage.set(STORAGE_KEYS.CURRENT_LESSON, currentLesson.toString());
                await window.storage.set(STORAGE_KEYS.STATS, JSON.stringify(stats));
                await window.storage.set(STORAGE_KEYS.CUSTOM_CHARS, JSON.stringify(Array.from(customCharacters)));
                await window.storage.set(STORAGE_KEYS.SELECTED_GROUP, selectedGroup);
            } catch (error) {
                console.log('Progress save skipped:', error);
            }
        }

        async function loadProgress() {
            try {
                const lessonData = await window.storage.get(STORAGE_KEYS.CURRENT_LESSON);
                if (lessonData) {
                    currentLesson = parseInt(lessonData.value);
                }

                const statsData = await window.storage.get(STORAGE_KEYS.STATS);
                if (statsData) {
                    stats = JSON.parse(statsData.value);
                }

                const customCharsData = await window.storage.get(STORAGE_KEYS.CUSTOM_CHARS);
                if (customCharsData) {
                    const chars = JSON.parse(customCharsData.value);
                    customCharacters = new Set(chars);
                }

                const groupData = await window.storage.get(STORAGE_KEYS.SELECTED_GROUP);
                if (groupData) {
                    selectedGroup = groupData.value;
                }
            } catch (error) {
                console.log('No saved progress found, starting fresh');
            }
        }

        async function saveSettings() {
            try {
                const settings = {
                    wpm: document.getElementById('wpm').value,
                    frequency: document.getElementById('frequency').value,
                    volume: document.getElementById('volume').value,
                    trainingMode: document.getElementById('trainingMode').value,
                    groupSize: document.getElementById('groupSize').value,
                    sessionDuration: document.getElementById('sessionDuration').value
                };
                await window.storage.set(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            } catch (error) {
                console.log('Settings save skipped:', error);
            }
        }

        async function loadSettings() {
            try {
                const settingsData = await window.storage.get(STORAGE_KEYS.SETTINGS);
                if (settingsData) {
                    const settings = JSON.parse(settingsData.value);
                    document.getElementById('wpm').value = settings.wpm || 20;
                    document.getElementById('frequency').value = settings.frequency || 600;
                    document.getElementById('volume').value = settings.volume || 70;
                    document.getElementById('trainingMode').value = settings.trainingMode || 'custom';
                    document.getElementById('groupSize').value = settings.groupSize || 5;
                    document.getElementById('sessionDuration').value = settings.sessionDuration || 20;
                    
                    updateSpeedDisplay();
                    updateAudioDisplay();
                }
            } catch (error) {
                console.log('No saved settings found, using defaults');
            }
        }

        async function saveCollapsedSections() {
            try {
                await window.storage.set(STORAGE_KEYS.COLLAPSED_SECTIONS, JSON.stringify(Array.from(collapsedSections)));
            } catch (error) {
                console.log('Collapsed sections save skipped:', error);
            }
        }

        async function loadCollapsedSections() {
            try {
                const sectionsData = await window.storage.get(STORAGE_KEYS.COLLAPSED_SECTIONS);
                if (sectionsData) {
                    const sections = JSON.parse(sectionsData.value);
                    collapsedSections = new Set(sections);
                }
            } catch (error) {
                console.log('No saved collapsed sections, all expanded by default');
            }
        }

        async function resetProgress() {
            if (confirm('Are you sure you want to reset all your progress? This cannot be undone.')) {
                try {
                    await window.storage.delete(STORAGE_KEYS.CURRENT_LESSON);
                    await window.storage.delete(STORAGE_KEYS.STATS);
                    await window.storage.delete(STORAGE_KEYS.CUSTOM_CHARS);
                    await window.storage.delete(STORAGE_KEYS.SELECTED_GROUP);
                    await window.storage.delete(STORAGE_KEYS.SETTINGS);
                    await window.storage.delete(STORAGE_KEYS.COLLAPSED_SECTIONS);
                    
                    currentLesson = 1;
                    stats = { correct: 0, total: 0, streak: 0, maxStreak: 0 };
                    customCharacters.clear();
                    selectedGroup = 'basic';
                    collapsedSections.clear();
                    
                    // Reset settings to defaults
                    document.getElementById('wpm').value = 20;
                    document.getElementById('frequency').value = 600;
                    document.getElementById('volume').value = 70;
                    document.getElementById('trainingMode').value = 'custom';
                    document.getElementById('groupSize').value = 5;
                    document.getElementById('sessionDuration').value = 20;
                    
                    updateSpeedDisplay();
                    updateAudioDisplay();
                    updateCharacterGrid();
                    updateStats();
                    selectCharacterGroup('basic');
                    createCustomCharacterGrid();
                    
                    // Expand all sections
                    document.querySelectorAll('.section-content').forEach(content => {
                        content.classList.remove('collapsed');
                        content.style.maxHeight = content.scrollHeight + 'px';
                    });
                    document.querySelectorAll('.toggle-btn').forEach(btn => {
                        btn.textContent = 'Hide';
                    });
                    
                    alert('Progress reset successfully!');
                } catch (error) {
                    console.error('Error resetting progress:', error);
                    alert('Progress reset complete (local storage)');
                }
            }
        }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>